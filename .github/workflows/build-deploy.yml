name: Build and Deploy to Pages Branch

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²è®°å½•ä»¥ä¾¿æ£€æŸ¥pagesåˆ†æ”¯
        
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Create temporary build directory
      run: |
        # åˆ›å»ºä¸´æ—¶æž„å»ºç›®å½•
        mkdir -p ./temp-build
        
        # å¤åˆ¶æž„å»ºè¾“å‡º
        cp -r ./.next ./temp-build/
        cp -r ./public ./temp-build/
        
        # å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
        cp package.json ./temp-build/
        cp package-lock.json ./temp-build/
        
        # åˆ›å»ºéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
        cat > ./temp-build/DEPLOYMENT_INFO.md << EOF
        # éƒ¨ç½²ä¿¡æ¯
        
        ## æž„å»ºæ—¶é—´
        $(date -u)
        
        ## æž„å»ºçŽ¯å¢ƒ
        - Node.js: ${{ matrix.node-version }}
        - OS: ubuntu-latest
        - åˆ†æ”¯: ${{ github.ref_name }}
        - æäº¤: ${{ github.sha }}
        
        ## æž„å»ºå‘½ä»¤
        \`\`\`bash
        npm ci
        npm run build
        \`\`\`
        
        ## æ–‡ä»¶ç»“æž„
        æ­¤ç›®å½•åŒ…å«å®Œæ•´çš„Next.jsæž„å»ºè¾“å‡ºï¼Œå¯ä»¥ç›´æŽ¥ç”¨äºŽéƒ¨ç½²ã€‚
        
        ## ä½¿ç”¨è¯´æ˜Ž
        1. è¿›å…¥æ­¤ç›®å½•: \`cd .\`
        2. å®‰è£…ä¾èµ–: \`npm install --production\`
        3. å¯åŠ¨æœåŠ¡: \`npm start\`
        
        ## åˆ†æ”¯ä¿¡æ¯
        - æºåˆ†æ”¯: ${{ github.ref_name }}
        - æºæäº¤: ${{ github.sha }}
        - æž„å»ºåˆ†æ”¯: pages
        
        ---
        è‡ªåŠ¨ç”ŸæˆäºŽ $(date -u)
        EOF
        
    - name: Setup Git for pages branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Check if pages branch exists
      id: check-pages
      run: |
        if git show-ref --verify --quiet refs/heads/pages; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Pages branch exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Pages branch does not exist"
        fi
        
    - name: Create pages branch if not exists
      if: steps.check-pages.outputs.exists == 'false'
      run: |
        echo "Creating orphan pages branch..."
        git checkout --orphan pages
        git rm -rf .
        echo "# Pages Branch" > README.md
        echo "This branch contains the build output of the main application." >> README.md
        git add README.md
        git commit -m "ðŸŒ± Initial pages branch"
        git push origin pages
        git checkout ${{ github.ref_name }}
        
    - name: Switch to pages branch and update
      run: |
        # åˆ‡æ¢åˆ°pagesåˆ†æ”¯
        git checkout pages
        
        # æ¸…ç†çŽ°æœ‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•å’ŒREADME.mdï¼‰
        find . -maxdepth 1 ! -name '.git' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
        
        # å¤åˆ¶æž„å»ºè¾“å‡º
        cp -r ./temp-build/* ./
        cp -r ./temp-build/.* ./ 2>/dev/null || true
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf ./temp-build
        
    - name: Commit and push to pages branch
      run: |
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "ðŸš€ è‡ªåŠ¨æ›´æ–°æž„å»ºè¾“å‡º - $(date -u)
          
          æž„å»ºä¿¡æ¯:
          - Node.jsç‰ˆæœ¬: ${{ matrix.node-version }}
          - æºåˆ†æ”¯: ${{ github.ref_name }}
          - æºæäº¤: ${{ github.sha }}
          - æž„å»ºæ—¶é—´: $(date -u)
          
          æ–‡ä»¶å˜æ›´:
          - æ›´æ–°Next.jsæž„å»ºè¾“å‡º
          - æ›´æ–°é™æ€èµ„æº
          - æ›´æ–°éƒ¨ç½²ä¿¡æ¯
          
          æ­¤æäº¤ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ"
          
          git push origin pages
          echo "âœ… æˆåŠŸæŽ¨é€åˆ°pagesåˆ†æ”¯"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æž„å»ºè¾“å‡ºå˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
        
    - name: Switch back to source branch
      run: |
        git checkout ${{ github.ref_name }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output-${{ matrix.node-version }}
        path: ./.next/
        retention-days: 30
        
    - name: Create build summary
      run: |
        echo "## ðŸš€ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.jsç‰ˆæœ¬**: \`${{ matrix.node-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **æºåˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æºæäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡åˆ†æ”¯**: \`pages\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ è¾“å‡ºä½ç½®" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºè¾“å‡º**: \`pages\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºäº§ç‰©**: å·²ä¸Šä¼ ä¸ºartifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… åŽç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
        echo "1. æž„å»ºè¾“å‡ºå·²æŽ¨é€åˆ° \`pages\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
        echo "2. å¯ä»¥ä»Žpagesåˆ†æ”¯éƒ¨ç½²åº”ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "3. æž„å»ºäº§ç‰©å¯åœ¨Actionsé¡µé¢ä¸‹è½½" >> $GITHUB_STEP_SUMMARY

  deploy-notification:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Send deployment notification
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºè¾“å‡ºå·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºè¾“å‡ºå·²æˆåŠŸæŽ¨é€åˆ° \`pages\` åˆ†æ”¯ï¼Œå¯ä»¥ç”¨äºŽéƒ¨ç½²ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»“åº“ä¸»é¡µ**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- **æºæäº¤**: [æŸ¥çœ‹æäº¤](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Pagesåˆ†æ”¯**: [æŸ¥çœ‹pagesåˆ†æ”¯](${{ github.server_url }}/${{ github.repository }}/tree/pages)" >> $GITHUB_STEP_SUMMARY
        echo "- **Actionsæ—¥å¿—**: [æŸ¥çœ‹æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
