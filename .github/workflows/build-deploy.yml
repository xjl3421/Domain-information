name: Build and Save to Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Create pages directory
      run: mkdir -p ./pages
      
    - name: Copy build output to pages directory
      run: |
        # Copy the entire .next directory to pages
        cp -r ./.next ./pages/
        # Copy public assets
        cp -r ./public ./pages/
        # Copy package.json and package-lock.json for deployment
        cp package.json ./pages/
        cp package-lock.json ./pages/
        
    - name: Create pages deployment info
      run: |
        cat > ./pages/DEPLOYMENT_INFO.md << EOF
        # éƒ¨ç½²ä¿¡æ¯
        
        ## æž„å»ºæ—¶é—´
        $(date -u)
        
        ## æž„å»ºçŽ¯å¢ƒ
        - Node.js: ${{ matrix.node-version }}
        - OS: ubuntu-latest
        - åˆ†æ”¯: ${{ github.ref_name }}
        - æäº¤: ${{ github.sha }}
        
        ## æž„å»ºå‘½ä»¤
        \`\`\`bash
        npm ci
        npm run build
        \`\`\`
        
        ## æ–‡ä»¶ç»“æž„
        æ­¤ç›®å½•åŒ…å«å®Œæ•´çš„Next.jsæž„å»ºè¾“å‡ºï¼Œå¯ä»¥ç›´æŽ¥ç”¨äºŽéƒ¨ç½²ã€‚
        
        ## ä½¿ç”¨è¯´æ˜Ž
        1. è¿›å…¥æ­¤ç›®å½•: \`cd pages\`
        2. å®‰è£…ä¾èµ–: \`npm install --production\`
        3. å¯åŠ¨æœåŠ¡: \`npm start\`
        
        ---
        è‡ªåŠ¨ç”ŸæˆäºŽ $(date -u)
        EOF
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output-${{ matrix.node-version }}
        path: ./pages/
        retention-days: 30
        
    - name: Commit pages changes
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ./pages/
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°æž„å»ºè¾“å‡º - $(date -u)
          
          æž„å»ºä¿¡æ¯:
          - Node.jsç‰ˆæœ¬: ${{ matrix.node-version }}
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          
          æ­¤æäº¤ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ"
          git push
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æž„å»ºè¾“å‡ºå˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
        
    - name: Create build summary
      run: |
        echo "## ðŸš€ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.jsç‰ˆæœ¬**: \`${{ matrix.node-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ è¾“å‡ºä½ç½®" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºè¾“å‡º**: \`./pages/\` ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºäº§ç‰©**: å·²ä¸Šä¼ ä¸ºartifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… åŽç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
        echo "1. æž„å»ºè¾“å‡ºå·²ä¿å­˜åˆ° \`./pages/\` ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "2. å¯ä»¥ç›´æŽ¥ä»Žè¯¥ç›®å½•éƒ¨ç½²åº”ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "3. æž„å»ºäº§ç‰©å¯åœ¨Actionsé¡µé¢ä¸‹è½½" >> $GITHUB_STEP_SUMMARY

  deploy-notification:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Send deployment notification
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºè¾“å‡ºå·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºè¾“å‡ºå·²æˆåŠŸä¿å­˜åˆ° \`./pages/\` ç›®å½•ï¼Œå¯ä»¥ç”¨äºŽéƒ¨ç½²ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»“åº“ä¸»é¡µ**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤è®°å½•**: [æŸ¥çœ‹æäº¤](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Actionsæ—¥å¿—**: [æŸ¥çœ‹æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY