name: Build and Deploy Next.js App

# 触发条件：当有推送到main分支时执行
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出代码仓库
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有历史记录，确保分支操作正常

      # 步骤2：设置Node.js环境
      - name: Set up Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'  # 缓存npm依赖，加速构建

      # 步骤3：安装项目依赖
      - name: Install dependencies
        run: npm install

      # 步骤4：构建Next.js项目
      - name: Build Next.js app
        run: npm run build

      # 步骤5：检出pages分支（如果不存在则创建）
      - name: Checkout pages branch
        uses: actions/checkout@v4
        with:
          ref: 'pages'
          path: 'pages-branch'  # 检出到pages-branch目录

      # 步骤6：将构建结果复制到pages分支的./pages文件夹
      - name: Copy build output to pages branch
        run: |
          # 创建目标目录（如果不存在）
          mkdir -p pages-branch/pages
          # 复制.next目录内容到目标位置
          cp -r .next/** pages-branch/pages/

      # 步骤7：提交并推送更改到pages分支
      - name: Commit and push changes
        working-directory: ./pages-branch
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add .
          git commit -m "Automatically deployed from main branch: $GITHUB_SHA" || echo "No changes to commit"
          git push origin pages
